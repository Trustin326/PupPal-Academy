<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PupPal Academy‚Ñ¢ ‚Äî Kid Lesson</title>
  <style>
    :root{
      --bg1:#150a2e; --bg2:#2a0f48;
      --card:#ffffff12; --glass:#ffffff18;
      --text:#ffffff; --muted:#e9dcffcc;
      --pink:#ff7ad9; --lav:#b89cff; --gold:#ffd36a; --mint:#6ef3d6;
      --shadow: 0 24px 70px rgba(0,0,0,.45);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 420px at 15% 10%, #ff7ad933, transparent 60%),
        radial-gradient(900px 420px at 85% 15%, #ffd36a2e, transparent 55%),
        radial-gradient(1100px 520px at 50% 92%, #6ef3d620, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{max-width:1050px;margin:0 auto;padding:18px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border-radius:18px;background:var(--glass);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      position:sticky;top:12px;z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:1000}
    .brand img{width:40px;height:40px;border-radius:14px;object-fit:cover;border:1px solid rgba(255,255,255,.14)}
    .pill{
      padding:10px 12px;border-radius:999px;
      background:#ffffff10;border:1px solid rgba(255,255,255,.12);
      color:var(--muted);font-weight:900;font-size:13px;
      display:flex;align-items:center;gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:0; cursor:pointer; font-weight:1000;
      padding:12px 14px; border-radius:16px;
      background: linear-gradient(135deg, var(--pink), var(--lav));
      color:#140725;
      box-shadow: 0 18px 45px rgba(184,156,255,.18);
    }
    .btn.secondary{
      background:#ffffff10;color:#fff;border:1px solid rgba(255,255,255,.14);box-shadow:none;
    }
    .btn.small{
      padding:10px 12px;
      border-radius:14px;
      font-weight:1100;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media(max-width:940px){ .grid{grid-template-columns:1fr} }

    .panel{
      background:var(--card);
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .banner{
      padding:14px 16px;
      background: radial-gradient(640px 220px at 30% 0%, #ff7ad93b, transparent 55%),
                  radial-gradient(640px 220px at 70% 10%, #ffd36a30, transparent 55%),
                  radial-gradient(700px 260px at 50% 120%, #6ef3d61c, transparent 60%),
                  #ffffff10;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .banner b{font-size:16px}
    .banner small{color:var(--muted);font-weight:900}

    .progressWrap{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      width:100%;
    }
    .bar{
      height:12px;
      flex:1;
      min-width:180px;
      border-radius:999px;
      background:#ffffff12;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--mint), var(--lav), var(--pink), var(--gold));
      border-radius:999px;
      transition: width .35s ease;
    }

    .question{
      padding:16px;
      display:grid;
      gap:12px;
    }
    .big{
      font-size: clamp(28px, 3.6vw, 44px);
      line-height:1.05;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .hint{color:var(--muted);font-weight:900}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      font-size:12px;font-weight:1000;
      padding:7px 10px;border-radius:999px;
      background:#ffffff10;border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
    }

    .choices{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:520px){ .choices{grid-template-columns:1fr 1fr} }
    .choice{
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff10;
      border-radius:18px;
      padding:18px 14px;
      cursor:pointer;
      font-weight:1100;
      font-size:26px;
      text-align:center;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
      user-select:none;
      position:relative;
    }
    .choice:hover{transform: translateY(-2px);border-color: rgba(255,211,106,.40)}
    .choice:active{transform: translateY(1px)}
    .choice.good{background: rgba(110,243,214,.16); border-color: rgba(110,243,214,.55)}
    .choice.bad{background: rgba(255,122,217,.14); border-color: rgba(255,122,217,.55)}

    /* tiny speaker icon inside choices */
    .choice .spk{
      position:absolute; right:10px; top:10px;
      font-size:14px; opacity:.85;
      background:#ffffff10;
      border:1px solid rgba(255,255,255,.12);
      padding:6px 8px;
      border-radius:12px;
    }

    .rewardBar{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      background:#00000018;
      align-items:center;
      justify-content:space-between;
    }
    .stars{display:flex;gap:6px;align-items:center;font-weight:1100}
    .star{
      width:18px;height:18px;border-radius:6px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.12);
    }
    .star.on{background: linear-gradient(135deg, var(--gold), #fff1b5); border-color: rgba(255,211,106,.5)}
    .toast{
      min-height:44px;
      display:flex;align-items:center;
      padding:12px 14px;border-radius:16px;
      background:#ffffff10;border:1px solid rgba(255,255,255,.12);
      color:var(--muted);font-weight:1000;
      flex:1;
    }

    .mascotImg{width:100%;display:block;height:260px;object-fit:cover;border-bottom:1px solid rgba(255,255,255,.10)}
    .coach{padding:14px 16px;display:grid;gap:10px}
    .coach .say{
      background:#ffffff10;border:1px solid rgba(255,255,255,.12);
      border-radius:18px;padding:12px 12px;
      font-weight:1000;color:var(--muted);line-height:1.45;
    }
    .miniRow{display:flex;gap:10px;flex-wrap:wrap}
    .miniBtn{
      border:0; cursor:pointer; font-weight:1100;
      padding:12px 12px;border-radius:16px;
      background: linear-gradient(135deg, var(--gold), #fff1b5);
      color:#1b0b31;
      flex:1;
    }
    .miniBtn.secondary{background:#ffffff10;color:#fff;border:1px solid rgba(255,255,255,.14)}

    select{
      border-radius:14px;border:1px solid rgba(255,255,255,.16);
      background:#ffffff10;color:#fff;
      padding:10px 12px;font-weight:900;
      outline:none;
    }

    .celebrate{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; place-items:center;
      z-index:50;
      padding:16px;
    }
    .celebrate .box{
      width:min(860px, 96vw);
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(14px);
      border-radius:26px;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr 1fr;
    }
    @media(max-width:860px){ .celebrate .box{grid-template-columns:1fr} }
    .celebrate img{width:100%;height:100%;object-fit:cover;display:block}
    .celebrate .content{padding:18px}
    .celebrate h2{margin:0 0 6px;font-size:32px}
    .celebrate p{margin:0;color:var(--muted);font-weight:900;line-height:1.55}
    .celebrate .actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}

    /* audio status */
    .audioNote{
      margin-left:auto;
      color:var(--muted);
      font-weight:1000;
      font-size:12px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="assets/logo.png" alt="Princess Pup logo">
        <div>
          PupPal Academy‚Ñ¢<br>
          <small style="color:var(--muted);font-weight:900">Kid Mode</small>
        </div>
      </div>

      <div class="pill">
       <div class="pill">
  ‚≠ê Quest: <span id="questName" style="color:#fff">ABC Magic</span>
  <button id="unlockAudio" class="btn small" onclick="unlockAudio()">üîä Enable Sound</button>
</div>

        <span style="opacity:.55">‚Ä¢</span>
        Age:
        <select id="age">
          <option value="4-5">4‚Äì5</option>
          <option value="6-7">6‚Äì7</option>
          <option value="8-9">8‚Äì9</option>
        </select>
      </div>

      <button class="btn secondary" onclick="location.href='index.html'">Back</button>
    </div>

    <div class="grid">
      <!-- Main lesson panel -->
      <div class="panel">
        <div class="banner">
          <div>
            <b>Princess Pup‚Äôs Lesson</b><br>
            <small id="lessonMeta">Tap the correct answer!</small>
          </div>

          <div class="progressWrap">
            <div class="pill">‚úÖ <span id="qCount">1</span>/<span id="qTotal">5</span></div>
            <div class="bar" aria-label="Lesson progress"><div id="barFill"></div></div>
            <span class="audioNote" id="audioStatus">üîä Tap ‚ÄúHear it‚Äù to start</span>
          </div>
        </div>

        <div class="question">
          <div class="tags" id="tags"></div>
          <div class="big" id="qText"></div>
          <div class="hint" id="qHint"></div>

         <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
  <button class="btn small" id="soundBtn" onclick="repeatSound()">üîÅ Sound</button>
  <button class="btn small" id="hearBtn" onclick="hearQuestion()">üîä Hear Question</button>
  <button class="btn small secondary" onclick="toggleVoice()">Voice: <span id="voiceOn">ON</span></button>
</div>


          <div class="choices" id="choices"></div>
        </div>

        <div class="rewardBar">
          <div class="stars" aria-label="Stars progress">
            <div class="star on" id="s1"></div>
            <div class="star" id="s2"></div>
            <div class="star" id="s3"></div>
            <span style="margin-left:8px;color:var(--muted);font-weight:1100">Stars</span>
          </div>
          <div class="toast" id="toast">Princess Pup: ‚ÄúReady? Tap your answer!‚Äù</div>
          <button class="btn" id="nextBtn" onclick="nextCard()" disabled>Next</button>
        </div>
      </div>

      <!-- Mascot coach panel -->
      <div class="panel">
        <img class="mascotImg" id="coachImg" src="assets/feature-phonics.png" alt="Princess Pup teaching">
        <div class="coach">
          <div class="say" id="coachSay">‚ÄúYou‚Äôve got this, superstar! Tap the right one!‚Äù</div>
          <div class="miniRow">
            <button class="miniBtn" onclick="showCelebrate()">üéâ Rewards Closet</button>
            <button class="miniBtn secondary" onclick="switchSkill()">Switch Skill</button>
          </div>
          <div class="say" style="opacity:.95">
            Tip: For iPhone/iPad, tap ‚ÄúHear it‚Äù once to enable audio.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Celebration overlay -->
  <div class="celebrate" id="celebrate" role="dialog" aria-modal="true">
    <div class="box">
      <img src="assets/feature-rewards.png" alt="Rewards closet">
      <div class="content">
        <h2>üéÄ Reward Unlocked!</h2>
        <p id="rewardText">Princess Pup added a sparkle accessory to your closet. Keep going to unlock more!</p>
        <div class="actions">
          <button class="btn" onclick="closeCelebrate()">Keep Learning ‚ú®</button>
          <button class="btn secondary" onclick="closeCelebrate()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ASSETS = { phonics:"assets/feature-phonics.png", math:"assets/feature-math.png" };

    // ------- SPEECH (Web Speech API) -------
    const canSpeak = "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
    let voiceEnabled = true;
    let cachedVoices = [];
    let selectedVoice = null;

    const audioStatus = document.getElementById("audioStatus");
    const voiceOnEl = document.getElementById("voiceOn");

    function loadVoices(){
      if(!canSpeak) return;
      cachedVoices = speechSynthesis.getVoices() || [];
      // pick a friendly English voice if possible
      selectedVoice =
        cachedVoices.find(v => /en/i.test(v.lang) && /female|woman|Samantha|Ava|Google US English/i.test(v.name)) ||
        cachedVoices.find(v => /en/i.test(v.lang)) ||
        cachedVoices[0] || null;
    }
    if(canSpeak){
      speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
      audioStatus.textContent = "üîä Ready (tap Hear it)";
    } else {
      audioStatus.textContent = "üîá Audio not supported in this browser";
    }
function speak(text, opts={}){
  if(!audioUnlocked) return;
  if(!("speechSynthesis" in window)) return;

  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    if(selectedVoice) u.voice = selectedVoice;
    u.rate = opts.rate ?? 0.95;
    u.pitch = opts.pitch ?? 1.1;
    u.volume = opts.volume ?? 1;
    speechSynthesis.speak(u);
  } catch(e){}
}

      if(!canSpeak || !voiceEnabled) return;
      try{
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        if(selectedVoice) u.voice = selectedVoice;
        u.rate = opts.rate ?? 0.95;
        u.pitch = opts.pitch ?? 1.1;
        u.volume = opts.volume ?? 1;
        u.onstart = () => audioStatus.textContent = "üîä Speaking‚Ä¶";
        u.onend = () => audioStatus.textContent = "üîä Ready";
        speechSynthesis.speak(u);
      } catch(e){
        audioStatus.textContent = "üîá Audio blocked‚Äîtap Hear it again";
      }
    }

    function toggleVoice(){
      voiceEnabled = !voiceEnabled;
      voiceOnEl.textContent = voiceEnabled ? "ON" : "OFF";
      if(!voiceEnabled && canSpeak) speechSynthesis.cancel();
    }

    // helper: kid-friendly pronunciations for sounds
    function saySound(symbol){
      const map = {
        "/p/":"puh", "/b/":"buh", "/t/":"tuh", "/sh/":"shh", "/ch/":"chh"
      };
      return map[symbol] || symbol;
    }

    // ------- CONTENT (multi-card lesson) -------
    const DECKS = {
      phonics: {
        "4-5": [
          mkMC("Which letter makes the ‚ÄúPuh!‚Äù sound?", "Hint: It‚Äôs the first letter in PUP.", ["P","B","T"], "P",
            ["Phonological Awareness","Letter-Sound"],
            { speakQ: "Which letter makes the puh sound?", speakHint: "Hint: It‚Äôs the first letter in pup." }
          ),
          mkMC("Tap the letter A", "Hint: It looks like a mountain.", ["A","O","M"], "A",
            ["Letter ID"],
            { speakQ: "Tap the letter A.", speakHint: "Hint: It looks like a mountain." }
          ),
          mkMC("Which word starts with P?", "Hint: Say each one out loud.", ["PUP","CAT","SUN"], "PUP",
            ["Initial Sound"],
            { speakQ: "Which word starts with P?", speakHint: "Hint: Say each one out loud." }
          ),
          mkMC("Tap the word that rhymes with CAT", "Hint: Same ending sound.", ["HAT","DOG","PEN"], "HAT",
            ["Rhyming"],
            { speakQ: "Tap the word that rhymes with cat.", speakHint: "Hint: Same ending sound." }
          ),
          mkMC("Which letter is in PUP twice?", "Hint: P‚Ä¶U‚Ä¶P", ["P","U","T"], "P",
            ["Letter Knowledge"],
            { speakQ: "Which letter is in pup twice?", speakHint: "Hint: P‚Ä¶U‚Ä¶P." }
          )
        ],
        "6-7": [
        mkMC(
  "Pick the word that starts with SH",
  "Hint: /sh/ like ‚Äúshoe‚Äù.",
  ["SHIP","CAT","RUG"],
  "SHIP",
  ["Phonics","Digraphs"],
  { speakQ: "Pick the word that starts with S H.", speakHint: "Hint: shh, like shoe.", phoneme: "sh" }
),

          mkMC("Which word has a long A sound?", "Hint: Like ‚Äúcake‚Äù.", ["CAKE","CAP","COT"], "CAKE",
            ["Vowel Patterns"],
            { speakQ: "Which word has a long A sound?", speakHint: "Hint: like cake." }
          ),
          mkMC("Choose the word with 2 syllables", "Hint: Clap it out.", ["PENCIL","CAT","MAP"], "PENCIL",
            ["Syllables"],
            { speakQ: "Choose the word with two syllables.", speakHint: "Hint: clap it out." }
          ),
        mkMC(
  "Pick the correct spelling",
  "Hint: /ch/ sound.",
  ["CHAIR","SAIR","CAIR"],
  "CHAIR",
  ["Phonics","Consonant Teams"],
  { speakQ: "Pick the correct spelling.", speakHint: "Hint: chh sound.", phoneme: "ch" }
),

          mkMC("Which is a sight word?", "Hint: You see it a lot.", ["THE","BLOP","TRIM"], "THE",
            ["High-Frequency Words"],
            { speakQ: "Which is a sight word?", speakHint: "Hint: you see it a lot." }
          )
        ],
        "8-9": [
          mkMC("Choose the word with a prefix meaning 'again'", "Hint: re- means again.", ["REPLAY","PLAY","PLAYS"], "REPLAY",
            ["Morphology","Prefixes"],
            { speakQ: "Choose the word with a prefix meaning again.", speakHint: "Hint: re means again." }
          ),
          mkMC("Pick the word with 'tion' ending sound", "Hint: /shun/.", ["NATION","NATE","NATURE"], "NATION",
            ["Word Study"],
            { speakQ: "Pick the word with shun at the end.", speakHint: "Hint: like na-shun." }
          ),
          mkMC("Which word is a synonym for 'happy'?", "Hint: Same meaning.", ["GLAD","MAD","SAD"], "GLAD",
            ["Vocabulary"],
            { speakQ: "Which word means the same as happy?", speakHint: "Hint: same meaning." }
          ),
          mkMC("Choose the best sentence", "Hint: Capital + period.", ["We play.","we play","We play"], "We play.",
            ["Conventions"],
            { speakQ: "Choose the best sentence.", speakHint: "Hint: capital letter and period." }
          ),
          mkMC("Which word is spelled correctly?", "Hint: Common tricky word.", ["BECAUSE","BECUZ","BECAUS"], "BECAUSE",
            ["Spelling/HFW"],
            { speakQ: "Which word is spelled correctly?", speakHint: "Hint: common tricky word." }
          )
        ]
      },

      math: {
        "4-5": [
          mkMC("How many gifts do you see? (Pick the number)", "Hint: Count 1‚Ä¶2‚Ä¶3‚Ä¶", ["5","3","7"], "5",
            ["Counting","Cardinality"],
            { speakQ: "How many gifts do you see? Pick the number.", speakHint: "Hint: count one, two, three." }
          ),
          mkMC("Which number comes after 6?", "Hint: 6 then‚Ä¶", ["7","5","9"], "7",
            ["Number Order"],
            { speakQ: "Which number comes after six?", speakHint: "Hint: six then..." }
          ),
          mkMC("Tap the bigger number", "Hint: Which is MORE?", ["9","4","2"], "9",
            ["Compare Numbers"],
            { speakQ: "Tap the bigger number.", speakHint: "Hint: which is more?" }
          ),
          mkMC("What is 2 + 1?", "Hint: Count up.", ["3","2","4"], "3",
            ["Add Within 5"],
            { speakQ: "What is two plus one?", speakHint: "Hint: count up." }
          ),
          mkMC("How many are left? 5 - 2", "Hint: Take away 2.", ["3","2","4"], "3",
            ["Subtract Within 5"],
            { speakQ: "How many are left? five minus two.", speakHint: "Hint: take away two." }
          )
        ],
        "6-7": [
          mkMC("What is 9 + 6?", "Hint: Make a 10.", ["15","14","16"], "15",
            ["Add Within 20"],
            { speakQ: "What is nine plus six?", speakHint: "Hint: make a ten." }
          ),
          mkMC("What is 13 - 7?", "Hint: Count back.", ["6","5","7"], "6",
            ["Subtract Within 20"],
            { speakQ: "What is thirteen minus seven?", speakHint: "Hint: count back." }
          ),
          mkMC("Which is an even number?", "Hint: Can you make pairs?", ["8","7","9"], "8",
            ["Even/Odd"],
            { speakQ: "Which is an even number?", speakHint: "Hint: can you make pairs?" }
          ),
          mkMC("Pick the correct equation", "Hint: Total is 12.", ["7+5=12","7+4=12","6+5=12"], "7+5=12",
            ["Equations"],
            { speakQ: "Pick the correct equation. Total is twelve.", speakHint: "Hint: total is twelve." }
          ),
          mkMC("Which is greater?", "Hint: Compare tens then ones.", ["18","16","19"], "19",
            ["Compare Numbers"],
            { speakQ: "Which is greater?", speakHint: "Hint: compare tens then ones." }
          )
        ],
        "8-9": [
          mkMC("What is 34 + 18?", "Hint: Add tens + ones.", ["52","42","62"], "52",
            ["2-Digit Addition"],
            { speakQ: "What is thirty four plus eighteen?", speakHint: "Hint: add tens and ones." }
          ),
          mkMC("What is 50 - 27?", "Hint: Borrow if needed.", ["23","33","27"], "23",
            ["2-Digit Subtraction"],
            { speakQ: "What is fifty minus twenty seven?", speakHint: "Hint: borrow if needed." }
          ),
          mkMC("Which number has 6 tens?", "Hint: 6 tens = 60.", ["60","16","600"], "60",
            ["Place Value"],
            { speakQ: "Which number has six tens?", speakHint: "Hint: six tens equals sixty." }
          ),
          mkMC("What is 3 √ó 4?", "Hint: 3 groups of 4.", ["12","7","14"], "12",
            ["Foundations of Multiplication"],
            { speakQ: "What is three times four?", speakHint: "Hint: three groups of four." }
          ),
          mkMC("Which fraction is half?", "Hint: One out of two equal parts.", ["1/2","2/1","1/4"], "1/2",
            ["Fractions Intro"],
            { speakQ: "Which fraction is half?", speakHint: "Hint: one out of two equal parts." }
          )
        ]
      }
    };

    function mkMC(q, hint, options, correct, tags, audio){
      return { type:"mc", q, hint, options, correct, tags, audio: audio || {} };
    }

    // State
    let skill = "phonics";
    let ageBand = "4-5";
    let deck = [];
    let i = 0;
    let stars = 1;
    let locked = false;

    // UI
    const questName = document.getElementById("questName");
    const coachImg = document.getElementById("coachImg");
    const qText = document.getElementById("qText");
    const qHint = document.getElementById("qHint");
    const choicesEl = document.getElementById("choices");
    const toast = document.getElementById("toast");
    const coachSay = document.getElementById("coachSay");
    const tagsEl = document.getElementById("tags");
    const nextBtn = document.getElementById("nextBtn");
    const qCount = document.getElementById("qCount");
    const qTotal = document.getElementById("qTotal");
    const barFill = document.getElementById("barFill");
    const lessonMeta = document.getElementById("lessonMeta");
    const ageSelect = document.getElementById("age");
    const rewardText = document.getElementById("rewardText");
    const hearBtn = document.getElementById("hearBtn");

    ageSelect.addEventListener("change", ()=>{
      ageBand = ageSelect.value;
      startLesson(true);
    });

    function startLesson(resetTalk){
      deck = DECKS[skill][ageBand].slice();
      i = 0;
      stars = 1;
      locked = false;
      nextBtn.disabled = true;
      nextBtn.textContent = "Next";
      qTotal.textContent = String(deck.length);
      renderCard();

      if(resetTalk){
        speak("New lesson. Tap your answer!", {rate: 0.95, pitch: 1.15});
      }
      updateStars();
    }

    function renderCard(){
      locked = false;
      nextBtn.disabled = true;

      const card = deck[i];
      const title = skill === "phonics" ? "ABC Magic" : "Gift Box Counting";
      questName.textContent = title;
      coachImg.src = (skill === "phonics") ? ASSETS.phonics : ASSETS.math;

      qText.textContent = card.q;
      qHint.textContent = card.hint;

      tagsEl.innerHTML = (card.tags || []).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");

      // choices include a tiny speaker badge
      choicesEl.innerHTML = card.options.map(o=>`
        <div class="choice" data-val="${escapeAttr(o)}" role="button" tabindex="0">
          ${escapeHtml(o)}
          <span class="spk">üîä</span>
        </div>
      `).join("");

      bindChoices(card);
      updateProgress();

      lessonMeta.textContent = skill === "phonics"
        ? "Literacy: sounds ‚Üí letters ‚Üí words"
        : "Math: counting ‚Üí add/subtract ‚Üí place value";

      coachSay.textContent = "‚ÄúYou‚Äôve got this, superstar! Tap the right one!‚Äù";
      toast.textContent = `Princess Pup: ‚ÄúQuestion ${i+1}! Tap your answer!‚Äù`;

      // auto-speak question once per card (gentle)
      speakCardIntro(card);
    }

    function bindChoices(card){
      [...document.querySelectorAll(".choice")].forEach(el=>{
        const click = ()=> {
          if(locked) return;
          checkChoice(el, card);
        };

        el.addEventListener("click", (e)=>{
          // If user tapped the speaker badge area, just read the option
          if(e.target && e.target.classList.contains("spk")){
            readOption(el.dataset.val);
            return;
          }
          click();
        });

        // keyboard accessible
        el.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            click();
          }
        });

        // long-press feel for mobile: read option on press
        el.addEventListener("pointerdown", ()=>{
          readOption(el.dataset.val);
        });
      });
    }

    function checkChoice(el, card){
      const val = el.dataset.val;

      if(val === card.correct){
        locked = true;
        el.classList.add("good");
        stars = Math.min(3, stars + 1);
        updateStars();
        nextBtn.disabled = false;

        toast.textContent = "Correct! ‚ú® Princess Pup is proud of you!";
        coachSay.textContent = "‚ÄúYay!! High paw! üêæ‚Äù";
        speak("Correct! Great job!", {rate: 0.95, pitch: 1.2});

        if(i === deck.length - 1){
          nextBtn.textContent = "Finish ‚ú®";
          rewardText.textContent = "You finished the lesson! Princess Pup added a NEW outfit item to your closet!";
        } else {
          nextBtn.textContent = "Next";
        }

        if(stars === 3){
          setTimeout(()=> {
            rewardText.textContent = "Sparkle streak! ‚≠ê‚≠ê‚≠ê You unlocked a bonus accessory!";
            showCelebrate();
            speak("Sparkle streak! You unlocked a bonus accessory!", {rate: 0.92, pitch: 1.18});
          }, 350);
        }

      } else {
        el.classList.add("bad");
        toast.textContent = "Almost! Try again üíú";
        coachSay.textContent = "‚ÄúSo close‚Äîtry again! I believe in you!‚Äù";
        speak("Almost! Try again.", {rate: 0.95, pitch: 1.12});
        setTimeout(()=> el.classList.remove("bad"), 450);
      }
    }

    function nextCard(){
      if(!locked) return;

      if(i < deck.length - 1){
        i++;
        renderCard();
      } else {
        rewardText.textContent = "Lesson complete! üéÄ A new tiara + sparkle sticker were added to your closet!";
        showCelebrate();
        speak("Lesson complete! You earned a reward!", {rate: 0.92, pitch: 1.18});

        i = 0;
        locked = false;
        nextBtn.disabled = true;
        nextBtn.textContent = "Next";
        updateProgress();
      }
    }

    function updateStars(){
      document.getElementById("s1").classList.toggle("on", stars >= 1);
      document.getElementById("s2").classList.toggle("on", stars >= 2);
      document.getElementById("s3").classList.toggle("on", stars >= 3);
    }

    function updateProgress(){
      qCount.textContent = String(i+1);
      const pct = ((i) / (deck.length - 1 || 1)) * 100;
      barFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    function switchSkill(){
      skill = (skill === "phonics") ? "math" : "phonics";
      startLesson(true);
    }

    function showCelebrate(){
      document.getElementById("celebrate").style.display = "grid";
    }
    function closeCelebrate(){
      document.getElementById("celebrate").style.display = "none";
      // stop any speaking if closing
      if(canSpeak) speechSynthesis.cancel();
      audioStatus.textContent = canSpeak ? "üîä Ready" : "üîá Audio not supported";
    }

    // ---------- AUDIO actions ----------
    function speakCardIntro(card){
      if(!voiceEnabled) return;
      // Keep it short
      const q = card.audio?.speakQ || card.q;
      speak(q, {rate: 0.95, pitch: 1.15});
    }

    function hearQuestion()function repeatSound(){
  const card = deck[i];
  const phoneme = (card.audio && card.audio.phoneme) ? String(card.audio.phoneme).toLowerCase() : "";

  if(!phoneme){
    // If this card doesn't have a phoneme, fall back to reading the question
    speak("Let‚Äôs hear the whole question!", {rate: 0.92, pitch: 1.12});
    hearQuestion();
    return;
  }

  // Convert phoneme codes to kid-friendly sounds
  const soundMap = {
    "sh": "shh",
    "ch": "chh",
    "th": "thh",
    "ph": "f",
    "p": "puh",
    "b": "buh",
    "t": "tuh",
    "k": "kuh",
    "g": "guh",
    "m": "mmm",
    "n": "nnn",
    "s": "sss",
    "a-long": "Ayyy",
    "e-long": "Eeee",
    "i-long": "Eye",
    "o-long": "Ohh",
    "u-long": "Yooo"
  };

  const say = soundMap[phoneme] || phoneme;

  // Speak only the sound (slower, clearer)
  speak("Sound: " + say, {rate: 0.75, pitch: 1.1});
}
{
      const card = deck[i];
      const q = card.audio?.speakQ || card.q;
      const hint = card.audio?.speakHint || card.hint;
      speak(q + " " + hint, {rate: 0.92, pitch: 1.12});
    }

    function readOption(val){
      // Read options more slowly for young kids
      let text = String(val);
      // Make letter-only options sound like letters
      if(/^[A-Z]$/i.test(text)){
        text = "Letter " + text.toUpperCase();
      }
      // For common sound cues
      text = text.replace("/sh/", saySound("/sh/")).replace("/ch/", saySound("/ch/"));
      speak(text, {rate: 0.85, pitch: 1.15});
    }

    // ---------- helpers ----------
    function saySound(symbol){
      const map = { "/p/":"puh", "/b/":"buh", "/t/":"tuh", "/sh/":"shh", "/ch/":"chh" };
      return map[symbol] || symbol;
    }
    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(s).replaceAll("`","&#096;");
    }

    // expose for buttons
    window.nextCard = nextCard;
    window.repeatSound = repeatSound;
    window.switchSkill = switchSkill;
    window.showCelebrate = showCelebrate;
    window.closeCelebrate = closeCelebrate;
    window.hearQuestion = hearQuestion;
    window.toggleVoice = toggleVoice;

    // Boot
    ageSelect.value = ageBand;
    startLesson(false);
  </script>
</body>
</html>
